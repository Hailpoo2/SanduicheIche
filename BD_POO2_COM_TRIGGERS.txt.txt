CREATE TABLE produto (

codprod INTEGER NOT NULL,
descprod VARCHAR (50) NOT NULL,
vlrprod FLOAT NOT NULL,
qtdprod SMALLINT NOT NULL DEFAULT '0',
PRIMARY KEY (codprod)

);

CREATE SEQUENCE codprod
MINVALUE 1
START WITH 1
INCREMENT BY 1;

CREATE TABLE clientes (

codcli INTEGER NOT NULL AUTO_INCREMENT,
nomecli VARCHAR(50) NOT NULL,
telefone VARCHAR(20),
PRIMARY KEY (codcli)
);

CREATE SEQUENCE codcli 
MINVALUE 1
START WITH 1
INCREMENT BY 1;

CREATE TABLE pedido(

nuped INTEGER NOT NULL AUTO_INCREMENT,
vlrnota FLOAT NOT NULL, --CAMPO CALCULADO COM A SOMA DOS VLRTOT DA TABELA itens_pedido
codcli INTEGER NOT NULL DEFAULT '0',
PRIMARY KEY (nuped),
CONSTRAINT pedidofk FOREIGN KEY (codcli) REFERENCES clientes(codcli) 
);


CREATE TABLE itens_pedido(

nuped INTEGER NOT NULL,
codprod INTEGER NOT NULL,
qtdprod SMALLINT NOT NULL,
vlrprod FLOAT NOT NULL,
CONSTRAINT itens_pedidopk PRIMARY KEY (nuped,codprod,qtdprod),
CONSTRAINT ITEFK1 FOREIGN KEY (nuped) REFERENCES pedido(nuped), 
CONSTRAINT ITEFK2 FOREIGN KEY (codprod,vlrprod) REFERENCES produto(codprod,vlrprod) 

);

CREATE TABLE fecha_pedido(

nuped INTEGER NOT NULL,
vlrnota FLOAT,
VLRPAGO FLOAT,
VLRTROCO FLOAT,
CONSTRAINT FECHAPK PRIMARY KEY (nuped),
CONSTRAINT FECHAFK FOREIGN KEY (nuped) REFERENCES pedido(nuped)
);



-- TRIGGER PARA POPULAR TOTAL DA NOTA NO PEDIDO


CREATE TRIGGER TOTAL_NOTA ON ITENS_PEDIDO FOR INSERT AS

BEGIN 
DECLARE 

@VLRNOTA  FLOAT,
@VLRPROD  FLOAT,
@QTDPROD INT, 
@NUPED  INT 

BEGIN

UPDATE PEDIDO SET VLRNOTA =(@VLRPROD * @QTDPROD) WHERE NUPED = @NUPED

END 

END


-- TRIGGER PARA ATUALIZAR O ESTOQUE

CREATE TRIGGER BAIXA ESTOQUE ON ITENS_PEDIDO FOR INSERT AS 

BEGIN 
DECLARE 

@QTDPROD  INT, 
@CODPROD  INT 

BEGIN 

UPDATE PRODUTO SET QTDPROD = (QTDPROD - @QTDPROD) WHERE CODPROD = @CODPROD
END 

END

